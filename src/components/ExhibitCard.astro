---
import { Image } from 'astro:assets';

interface Props {
	title: string;
	author?: string;
	date?: string;
    tags?: string[];
	url: string;
    description?: string;
    image?: string; // Legacy string URL
    cover?: ImageMetadata; // Optimized Astro Image
    text_theme?: 'light' | 'dark'; // Adaptive legibility
}

const { title, date, url, description, image, tags, cover, text_theme = 'dark' } = Astro.props;

// Get first letter for watermark
const firstLetter = title.charAt(0).toUpperCase();

// Color Logic
const isLightTheme = text_theme === 'light';
const textColor = isLightTheme ? 'text-slate-900' : 'text-museum-paper';
const hoverTextColor = isLightTheme ? 'group-hover:text-museum-crimson' : 'group-hover:text-museum-gold';
const descColor = isLightTheme ? 'text-slate-700' : 'text-museum-paper/80';
const plaqueBorder = isLightTheme ? 'border-slate-900/30' : 'border-museum-paper/30';
const plaqueText = isLightTheme ? 'text-slate-900/70' : 'text-museum-paper/90';

// Default Colors for non-image cards (Gold/Dark)
const defaultTitleColor = 'text-museum-bg group-hover:text-museum-crimson';
const defaultDescColor = 'text-museum-ink/80';
const defaultPlaqueBorder = 'border-museum-gold/40';
const defaultPlaqueText = 'text-museum-ink/60';
---

<a href={url} class="group block relative perspective-1000">
	<article class="
		relative 
        bg-museum-paper 
        text-museum-ink 
        min-h-[320px] 
        flex flex-col 
        justify-between 
        border-4 border-double border-museum-gold 
        shadow-frame 
        transition-all duration-500 ease-out 
        group-hover:-translate-y-2 
        group-hover:shadow-[0_20px_40px_-10px_rgba(0,0,0,0.6),0_0_0_2px_#d4af37]
        group-hover:rotate-0
		overflow-hidden
	">
		<!-- Background Texture -->
		<div class="absolute inset-0 opacity-20 bg-noise pointer-events-none mix-blend-multiply"></div>

        {cover ? (
            // Image Cover Mode
            <div class="absolute inset-0 z-0">
                <Image src={cover} alt={title} width={800} height={600} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 sepia-[0.3]" />
                <div class="absolute inset-0 bg-gradient-to-t from-museum-bg/90 via-museum-bg/20 to-transparent"></div>
            </div>
        ) : image ? (
            // Legacy Image Mode (String URL)
            <div class="absolute inset-0 z-0">
                <img src={image} alt={title} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 sepia-[0.3]" />
                <div class="absolute inset-0 bg-gradient-to-t from-museum-bg/90 via-museum-bg/20 to-transparent"></div>
            </div>
        ) : (
            // Typography Cover Mode (Watermark)
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[12rem] font-display text-museum-gold/10 pointer-events-none select-none z-0">
                {firstLetter}
            </div>
        )}

        <!-- Content Content -->
		<div class="relative z-10 flex flex-col gap-4 p-8 h-full justify-end">
            <!-- Decorative Element -->
            {!image && !cover && <div class="w-12 h-1 bg-museum-gold/50 mb-auto"></div>}

			<!-- Title -->
			<h2 class={`font-display text-2xl md:text-3xl font-bold leading-tight transition-colors duration-300 ${image || cover ? `${textColor} ${hoverTextColor} drop-shadow-md` : defaultTitleColor}`}>
				{title}
			</h2>
            
            {description && (
                <p class={`font-body text-lg italic line-clamp-3 ${image || cover ? descColor : defaultDescColor}`}>
                    {description}
                </p>
            )}

            <!-- Plaque (Metadata) -->
            <div class={`mt-4 pt-4 border-t flex justify-between items-center text-xs tracking-[0.15em] font-display uppercase ${image || cover ? `${plaqueBorder} ${plaqueText}` : `${defaultPlaqueBorder} ${defaultPlaqueText}`}`}>
                <span class="font-bold text-museum-gold/80">{tags && tags[0] ? tags[0] : "Artifact"}</span>
                {date && <span>{new Date(date).getFullYear()}</span>}
            </div>
		</div>
        
        {/* Corner decorations (Only for text mode to avoid cluttering image) */}
        {!image && !cover && (
            <>
                <div class="absolute top-2 left-2 w-3 h-3 border-t border-l border-museum-gold/50"></div>
                <div class="absolute top-2 right-2 w-3 h-3 border-t border-r border-museum-gold/50"></div>
                <div class="absolute bottom-2 left-2 w-3 h-3 border-b border-l border-museum-gold/50"></div>
                <div class="absolute bottom-2 right-2 w-3 h-3 border-b border-r border-museum-gold/50"></div>
            </>
        )}

	</article>
</a>

<style>
    /* Add specific perspective or 3d transforms here if standard tailwind isn't enough */
    .perspective-1000 {
        perspective: 1000px;
    }
</style>
